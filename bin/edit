#!/bin/bash

if [ -d "$1" ]; then
  dir=$(realpath "$1")/
  target="$dir"
else
  dir=$(realpath "$(dirname "$1")")
  # read filename and line number out of ./foo.rb:41
  IFS=: read -r target linenumber <<< "$1"
  target=$(realpath "$target")
fi
emacsclient --alternate-editor="" --no-wait --quiet --suppress-output --eval "
;; using make-frame rather than 'emacsclient --create-frame' because the latter is a bit weird on macOS,
;; creating a second dock icon with the generic file icon rather than an emacs icon, and doesn't allow cmd-~ to switch windows
(let ((frame (make-frame '((display . \":0\")))))
  (modify-frame-parameters
    frame
    '((user-position . t) (top . 0.5) (left . 0.5)))
  (select-frame-set-input-focus frame)

  (if (file-directory-p \"$target\")
    (progn
      (dir-locals-set-class-variables 'vendor-directory
      '((nil . ((projectile-project-root . \"$dir\")))))
      (dir-locals-set-directory-class \"$dir\" 'vendor-directory)
      (add-to-list 'safe-local-variable-values '(projectile-project-root . \"$dir\"))
      (find-file \"$target\"))

    (+workspace/new)
    (find-file \"$target\")
    (goto-line ${linenumber:-1})
   )
)"
